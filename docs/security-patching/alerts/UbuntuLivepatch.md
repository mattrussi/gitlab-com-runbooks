# UbuntuLivepatch

**Table of Contents**

[TOC]

## Overview

[Ubuntu Livepatch](https://ubuntu.com/security/livepatch) is a service that provides online security fixes for High/Critical level severity security vulnerabilities in the Linux kernel. We use this service across our fleet in order to apply security fixes to systems that are difficult to reboot quickly.

## Services

- All Ubuntu VM instances that are managed by Chef should be enrolled in Ubuntu Advantage and have Livepatch enabled.

## Metrics

- The metric used for this alert is generated by [this shell script](https://gitlab.com/gitlab-cookbooks/gitlab-server/-/blob/master/templates/default/ubuntu_advantage-metrics.erb?ref_type=heads), which is installed on all Chef managed VM instances.
- The script writes a file with Prometheus formatted metrics, where the node_exporter process then exports them to Prometheus.
- The metric `canonical_livepatch_enabled` is generated based on the output of the `ua status` command, where the statuses of "warning" or "enabled" are considered enabled, anything else is interpreted as not enabled.
- A Systemd timer is installed to execute this script every 5 minutes.

## Alert Behavior

- The alert looks for any instances in GPRD that report Livepatch as being disabled, while also having run chef-client recently.

## Severities

- This alert is low severity, and intended to inform us when there are nodes that may not be receiving security patches as we intend.

## Verification

- [Grafana Explore](https://dashboards.gitlab.net/explore?schemaVersion=1&panes=%7B%223q5%22:%7B%22datasource%22:%22mimir-gitlab-gprd%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22canonical_livepatch_enabled%7Benvironment%3D%5C%22gprd%5C%22%7D%20%3D%3D%200%20and%20on%20%28fqdn,%20environment%29%20time%28%29%20-%20chef_client_last_run_timestamp_seconds%20%3C%203600%20%2A%206%22,%22range%22:true,%22instant%22:true,%22datasource%22:%7B%22type%22:%22prometheus%22,%22uid%22:%22mimir-gitlab-gprd%22%7D,%22editorMode%22:%22code%22,%22legendFormat%22:%22__auto%22%7D%5D,%22range%22:%7B%22from%22:%22now-1h%22,%22to%22:%22now%22%7D%7D%7D&orgId=1)
- You can verify the state of Livepatch on the machine using the command `sudo ua status`

## Troubleshooting

- Ensure chef-client runs are completing without error.
- If Chef is running, verify that the attribute that enables the Livepatch feature is set to `true`:
  - ```knife search node 'name:<nodename>' -a gitlab-server.ubuntu-advantage.livepatch```

## Possible Resolutions

- If the attribute mentioned above is false, find the roles associated with the node, and check to see if there is a misconfiguration that is resulting in the attribute being overridden.
- From the `ua status` command, ensure that the node is associated with our Ubuntu Advantage account.

## Dependencies

- Chef needs to be running on the instance for this alert to function.

# Escalation

- If this alert fires, it is likely a good idea to first check with the service owner for the VM instance, and see if this isn't intentional.
- For generic Livepatch related help, you can reach out in `#g_infra_ops` in Slack.

# Definitions

- [Alert definition](https://gitlab.com/gitlab-com/runbooks/-/tree/master/mimir-rules/gitlab-gprd/canonical-livepatch.md)
- [Update the template used to format this playbook](https://gitlab.com/gitlab-com/runbooks/-/edit/master/docs/template-alert-playbook.md?ref_type=heads)
