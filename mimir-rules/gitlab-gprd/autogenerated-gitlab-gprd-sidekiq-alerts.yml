# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/sidekiq-queue-rules.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Sidekiq Aggregated Alerts
  interval: 1m
  rules:
  - alert: sidekiq_throttled_jobs_enqueued_without_dequeuing
    for: 30m
    annotations:
      title: Sidekiq jobs are being enqueued without being dequeued
      description: |
        The `{{ $labels.worker}}` worker in the {{ $labels.queue }} queue appears to have jobs being enqueued without those jobs being executed.

        This could be the result of a Sidekiq server configuration issue, where no Sidekiq servers are configured to dequeue the specific worker.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_variables: environment,stage,worker
      promql_template_1: sidekiq_enqueued_jobs_total{environment="$environment", type="$type",
        stage="$stage", component="$component"}
      runbook: docs/sidekiq/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s4
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (
        sum by (env, queue, feature_category, worker) (
          sli_aggregations:sidekiq_enqueued_jobs_total:rate_1h{env="gprd",urgency="throttled"}
        ) > 0
      )
      unless
      (
        sum by (env, queue, feature_category, worker) (
          sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_1h{env="gprd",urgency="throttled"}
        ) > 0
      )
  - alert: SidekiqQueueNoLongerBeingProcessed
    for: 20m
    annotations:
      title: A Sidekiq queue is no longer being processed.
      description: Sidekiq queue {{ $labels.queue }} in shard {{ $labels.shard }}
        is no longer being processed.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-queue={{ $labels.queue
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3168042924"
      grafana_variables: environment,stage,queue
      promql_template_1: sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_6h{environment="$environment",
        queue="$queue"}
      runbook: docs/sidekiq/sidekiq-queue-not-being-processed.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s3
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (sum by(env, queue) (sli_aggregations:sidekiq_enqueued_jobs_total:rate_6h{env="gprd"})> 0.001)
      unless
      (sum by(env, queue) (sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_6h{env="gprd"}) > 0)
  - alert: SidekiqWorkerNoLongerBeingProcessed
    for: 20m
    annotations:
      title: A Sidekiq worker is no longer being processed.
      description: Sidekiq worker {{ $labels.worker }} in shard {{ $labels.shard }}
        is no longer being processed.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3168042924"
      grafana_variables: environment,stage,worker
      promql_template_1: sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_6h{environment="$environment",
        worker="$worker"}
      runbook: docs/sidekiq/sidekiq-queue-not-being-processed.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s3
      stage: main
      tier: sv
      type: sidekiq
    expr: |
      (sum by(env, worker) (sli_aggregations:sidekiq_enqueued_jobs_total:rate_1h{env="gprd"})> 0.001)
      unless
      (sum by(env, worker) (sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_1h{env="gprd"})  > 0)
  - alert: SidekiqJobsSkippedTooLong
    for: 3h
    annotations:
      title: Sidekiq jobs from `{{ $labels.worker }}` are intentionally being `{{
        $labels.action }}` for too long
      description: |
        Sidekiq jobs from `{{ $labels.worker }}` are being `{{ $labels.action }}` indefinitely via feature flag `run_sidekiq_jobs_<worker_name>` or `drop_sidekiq_jobs_<worker_name>`. This feature flag might be used during an incident and forgotten to be removed. Ignore if this is still intentionally left.

        Run `/chatops run feature list --match run_sidekiq_jobs` and `/chatops run feature list --match drop_sidekiq_jobs` to list currently used feature flags.
      grafana_dashboard_id: sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-worker={{ $labels.worker }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2019205131"
      grafana_variables: environment,worker
    labels:
      alert_type: cause
      severity: s4
      team: data-access:durability
    expr: |
      sum by (env, worker, action, reason)  (
        rate(
          sidekiq_jobs_skipped_total{env="gprd",reason="feature_flag"}[1h]
          )
        )
        > 0
  - alert: ScanDependenciesWorkerHighErrorRate
    for: 5m
    annotations:
      title: High error rate for `{{ $labels.worker }}`
      description: |
        Sidekiq jobs error rate from `{{ $labels.worker }}` has exceeded 0.1%. This may be caused by exceptions from unexpected data types or values in the job execution.
      grafana_dashboard_id: sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-worker={{ $labels.worker }}
      grafana_min_zoom_hours: "6"
      grafana_variables: environment,worker
    labels:
      aggregation: sidekiq_execution
      alert_type: symptom
      severity: s4
      sli_type: error
      team: code_creation
    expr: |
      sum by (env, worker) (
        application_sli_aggregation:sidekiq_execution:error:rate_5m{
          worker=~"Ai::RepositoryXray::ScanDependenciesWorker",
          env="gprd"
        }
      ) > 0.001
  - alert: SidekiqJobsDeferredByDBHealthCheck
    for: 2h
    annotations:
      title: Many Sidekiq jobs from `{{ $labels.worker }}` have been deferred by DB
        health check
      description: |
        {{ $value | humanizePercentage }} of Sidekiq jobs from `{{ $labels.worker }}` are being deferred via DB Health Check.

        Deferred jobs follow the same [indicators](https://docs.gitlab.com/ee/development/database/batched_background_migrations.html#throttling-batched-migrations) to throttle batched background migrations.

        When too many jobs are being deferred continuously, there could be a huge backlog of jobs impacting jobs from other worker classes.
      grafana_dashboard_id: sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-worker={{ $labels.worker }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2019205131"
      grafana_variables: environment,worker
    labels:
      alert_type: cause
      severity: s4
    expr: |
      sum by (env, worker, feature_category)  (
          rate(
              sidekiq_jobs_skipped_total{action="deferred",env="gprd",reason="database_health_check"}[1h]
          )
      )
      /
      sum by (env, worker, feature_category) (
          application_sli_aggregation:sidekiq_execution:ops:rate_1h{env="gprd"}
      )
      > 0.1
  - alert: SidekiqServiceWorkerExecutionApdexSLOViolation
    for: 1h
    annotations:
      title: The `{{ $labels.worker }}` Sidekiq worker, `{{ $labels.stage }}` stage,
        has an apdex violating SLO
      description: |
        The `{{ $labels.worker }}` worker is not meeting its apdex SLO.

        Currently the apdex value is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2504679775"
      grafana_variables: environment,stage,worker
      runbook: docs/sidekiq/README.md
    labels:
      aggregation: sidekiq_execution
      alert_class: slo_violation
      alert_type: symptom
      rules_domain: general
      severity: s4
      sli_type: apdex
      slo_alert: "yes"
      window: 6h
    expr: |
      (
        (
          sli_aggregations:gitlab_sli_sidekiq_execution_apdex_success_total:rate_1h{env="gprd"}
          /
          sli_aggregations:gitlab_sli_sidekiq_execution_apdex_total:rate_1h{env="gprd"}
        ) < 0.90000000000000002
        and
        (
          sli_aggregations:gitlab_sli_sidekiq_execution_apdex_success_total:rate_5m{env="gprd"}
          /
          sli_aggregations:gitlab_sli_sidekiq_execution_apdex_total:rate_5m{env="gprd"}
        ) < 0.90000000000000002
      )
      and on (env, environment, tier, type, stage, shard, queue, feature_category, urgency, worker)
      (
        sum by (env, environment, tier, type, stage, shard, queue, feature_category, urgency, worker) (
          sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_1h{env="gprd"}
        ) >= 0.055555555555555552
      )
  - alert: SidekiqServiceWorkerExecutionErrorSLOViolation
    for: 1h
    annotations:
      title: The `{{ $labels.worker }}` Sidekiq worker, `{{ $labels.stage }}` stage,
        has an error rate violating SLO
      description: |
        The `{{ $labels.worker }}` worker is not meeting its error-rate SLO.

        Currently the error-rate is {{ $value | humanizePercentage }}.
      grafana_dashboard_id: sidekiq-worker-detail/sidekiq-worker-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/sidekiq-worker-detail/sidekiq-worker-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}&var-worker={{ $labels.worker
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2383655193"
      grafana_variables: environment,stage,worker
      runbook: docs/sidekiq/README.md
    labels:
      aggregation: sidekiq_execution
      alert_class: slo_violation
      alert_type: symptom
      rules_domain: general
      severity: s4
      sli_type: error
      slo_alert: "yes"
      window: 6h
    expr: |
      (
        (
          sli_aggregations:gitlab_sli_sidekiq_execution_error_total:rate_1h{env="gprd"}
          /
          sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_1h{env="gprd"}
        ) > 0.10000000000000001
        and
        (
          sli_aggregations:gitlab_sli_sidekiq_execution_error_total:rate_5m{env="gprd"}
          /
          sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_5m{env="gprd"}
        ) > 0.10000000000000001
      )
      and on (env, environment, tier, type, stage, shard, queue, feature_category, urgency, worker)
      (
        sum by (env, environment, tier, type, stage, shard, queue, feature_category, urgency, worker) (
          sli_aggregations:gitlab_sli_sidekiq_execution_total:rate_1h{env="gprd"}
        ) >= 0.00013888888888888889
      )
