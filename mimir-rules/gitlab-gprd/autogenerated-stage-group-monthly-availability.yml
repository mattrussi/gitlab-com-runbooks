# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/stage-group-monthly-availability.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: 7d availability by stage group
  interval: 30m
  rules:
  - record: gitlab:stage_group:availability:ratio_7d
    labels:
      monitor: global
    expr: |
      clamp_max(
        sum by (stage_group,product_stage,environment)(
          sum by (stage_group,product_stage,environment,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:success:rate_1h{environment="gprd",monitor="global",stage="main"}[7d]
              ), 'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[7d]
              )
              -
              sum_over_time(
                gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[7d]
              ), 'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        )
        /
        sum by (stage_group,product_stage,environment)(
          sum by (stage_group,product_stage,environment,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:weight:score_1h{environment="gprd",monitor="global",stage="main"}[7d]
              ),
              'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[7d]
              )
              and sum_over_time(gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[7d]),
              'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        ),
      1)
- name: 28d availability by stage group
  interval: 30m
  rules:
  - record: gitlab:stage_group:availability:ratio_28d
    labels:
      monitor: global
    expr: |
      clamp_max(
        sum by (stage_group,product_stage,environment)(
          sum by (stage_group,product_stage,environment,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:success:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ), 'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              )
              -
              sum_over_time(
                gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ), 'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        )
        /
        sum by (stage_group,product_stage,environment)(
          sum by (stage_group,product_stage,environment,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:weight:score_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ),
              'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              )
              and sum_over_time(gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]),
              'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        ),
      1)
- name: 28d availability by stage group and SLI kind
  interval: 30m
  rules:
  - record: gitlab:stage_group:sli_kind:availability:ratio_28d
    labels:
      monitor: global
    expr: |
      clamp_max(
        sum by (stage_group,product_stage,environment,sli_kind)(
          sum by (stage_group,product_stage,environment,sli_kind,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:success:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ), 'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              )
              -
              sum_over_time(
                gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ), 'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        )
        /
        sum by (stage_group,product_stage,environment,sli_kind)(
          sum by (stage_group,product_stage,environment,sli_kind,stage_group,component) (
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:apdex:weight:score_1h{environment="gprd",monitor="global",stage="main"}[28d]
              ),
              'sli_kind', 'apdex', '', ''
            )
            or
            label_replace(
              sum_over_time(
                gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
              )
              and sum_over_time(gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]),
              'sli_kind', 'error', '', ''
            )
          ) unless on (stage_group,component) gitlab:ignored_component:stage_group
        ),
      1)
- name: 28d traffic share per stage group
  interval: 30m
  rules:
  - record: gitlab:stage_group:traffic_share:ratio_28d
    labels:
      monitor: global
    expr: |
      (
        sum by (environment,product_stage,stage_group) (
          label_replace(
            sum by (environment,product_stage,stage_group)(
              sum by (component,environment,product_stage,stage_group)(
                sum_over_time(
                  gitlab:component:stage_group:execution:apdex:weight:score_1h{environment="gprd",monitor="global",stage="main"}[28d]
                )
              ) unless on (stage_group,component) gitlab:ignored_component:stage_group
            ),
            'violation_type', 'apdex' , '', ''
          )
          or
          label_replace(
            sum by (environment,product_stage,stage_group)(
              sum by (component,environment,product_stage,stage_group)(
                sum_over_time(
                  gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
                )
                and sum_over_time(gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d])
              ) unless on (stage_group,component) gitlab:ignored_component:stage_group
            ),
            'violation_type', 'error' , '', ''
          )
        ) > 0
      )
      / ignoring(stage_group,product_stage) group_left()
      (
        sum by (environment) (
          label_replace(
            sum by (environment)(
              sum by (component,environment,stage_group)(
                sum_over_time(
                  gitlab:component:stage_group:execution:apdex:weight:score_1h{environment="gprd",monitor="global",stage="main"}[28d]
                )
              ) unless on (stage_group,component) gitlab:ignored_component:stage_group
            ),
            'violation_type', 'apdex' , '', ''
          )
          or
          label_replace(
            sum by (environment)(
              sum by (component,environment,stage_group)(
                sum_over_time(
                  gitlab:component:stage_group:execution:ops:rate_1h{environment="gprd",monitor="global",stage="main"}[28d]
                )
                and sum_over_time(gitlab:component:stage_group:execution:error:rate_1h{environment="gprd",monitor="global",stage="main"}[28d])
              ) unless on (stage_group,component) gitlab:ignored_component:stage_group
            ),
            'violation_type', 'error' , '', ''
          )
        ) > 0
      )
