# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/registry-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: patroni-registry extra alerts
  rules:
  - alert: ContainerRegistryDBLoadBalancerReplicaPoolSize
    for: 5m
    annotations:
      title: The Container Registry database load balancer replica pool size is too
        low.
      description: |
        The size of the application-side DB load balancer replica pool in env {{ $labels.environment }} {{ $labels.stage }} stage has been lower than the number of available standby replicas for the last 5 minutes.
      grafana_dashboard_id: registry-database/registry-database-detail
      grafana_dashboard_link: https://dashboards.gitlab.net/d/registry-database/registry-database-detail?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-stage={{ $labels.stage }}
      grafana_min_zoom_hours: "6"
      grafana_variables: environment,stage
      runbook: docs/registry/db-load-balancing.md
    labels:
      alert_type: symptom
      severity: s4
      team: container_registry
    expr: |
      (
        sum by (env, environment, stage) (
          pg_replication_is_replica{tier="db", type="patroni-registry", env="gprd"}
        ) - 1 # subtract 1 to exclude the backup replica, which is not advertised for load balancing
      )
      >
      max by (env, environment, stage) (
        registry_database_lb_pool_size{type="registry", env="gprd"}
      )
