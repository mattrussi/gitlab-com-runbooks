# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/service-health.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Autogenerated Mtbf Health Indicators
  interval: 1m
  rules:
  - record: gitlab_mtbf_health:service:errors
    expr: |
      clamp_max(
        (
          gitlab_service_errors:ratio_1h{env="gstg",monitor="global"}
          > bool on(type,tier) group_left()
          (
            14.4 * (
              avg by (type,tier) (slo:max:mtbf:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        *
        (
          gitlab_service_errors:ratio_5m{env="gstg",monitor="global"}
          > bool on(type,tier) group_left()
          (
            14.4 * (
              avg by (type,tier) (slo:max:mtbf:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        +
        (
          gitlab_service_errors:ratio_6h{env="gstg",monitor="global"}
          > bool on(type,tier) group_left()
          (
            6 * (
              avg by (type,tier) (slo:max:mtbf:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        )
        *
        (
          gitlab_service_errors:ratio_30m{env="gstg",monitor="global"}
          > bool on(type,tier) group_left()
          (
            6 * (
              avg by (type,tier) (slo:max:mtbf:gitlab_service_errors:ratio{monitor="global"})
            )
          )
        ),
        1
      ) == bool 0
  - record: gitlab_mtbf_health:service:apdex
    expr: |
      clamp_max(
        (
          gitlab_service_apdex:ratio_1h{env="gstg",monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              14.4 * (1 - avg by (type,tier) (slo:min:mtbf:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        *
        (
          gitlab_service_apdex:ratio_5m{env="gstg",monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              14.4 * (1 - avg by (type,tier) (slo:min:mtbf:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        +
        (
          gitlab_service_apdex:ratio_6h{env="gstg",monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              6 * (1 - avg by (type,tier) (slo:min:mtbf:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        )
        *
        (
          gitlab_service_apdex:ratio_30m{env="gstg",monitor="global"}
          < bool on(type,tier) group_left()
          (
            1 -
            (
              6 * (1 - avg by (type,tier) (slo:min:mtbf:gitlab_service_apdex:ratio{monitor="global"}))
            )
          )
        ),
        1
      ) == bool 0
  - record: gitlab_mtbf_health:service
    expr: |
      min without (sli_type) (
        label_replace(gitlab_mtbf_health:service:apdex{env="gstg",monitor="global"}, "sli_type", "apdex", "", "")
        or
        label_replace(gitlab_mtbf_health:service:errors{env="gstg",monitor="global"}, "sli_type", "errors", "", "")
      )
  - record: gitlab_mtbf_health:stage
    expr: |
      min by (environment, env, stage) (
        gitlab_mtbf_health:service{env="gstg",monitor="global"}
      )
