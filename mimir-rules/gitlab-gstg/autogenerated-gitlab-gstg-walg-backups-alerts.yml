# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/walg-backups-alerts.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: gitlab-walg-backup.rules
  rules:
  - record: gitlab_com:last_walg_backup_age_in_seconds
    expr: |
      min(time() - walg_backup_last_completed_time_seconds{env="gstg", type=~"patroni.*"}) by (env,environment,type)
  - record: gitlab_com:last_walg_basebackup_age_in_hours
    expr: |
      min without (fqdn,instance) (
        time() -
        (
          label_replace(gitlab_job_start_timestamp_seconds{resource="walg-basebackup", env="gstg", exported_type=~".*patroni.*"}, "type", "$1", "exported_type", "(.*)") > 0
        )
      ) / 3600
  - record: gitlab_com:last_walg_successful_basebackup_age_in_hours
    expr: |
      min without (fqdn,instance) (
        time() -
        (
          label_replace(gitlab_job_success_timestamp_seconds{resource="walg-basebackup", env="gstg", exported_type=~".*patroni.*"}, "type", "$1", "exported_type", "(.*)") > 0
        )
      ) / 3600
  - record: gitlab_com:last_walg_failed_basebackup_age_in_hours
    expr: |
      min(time() - label_replace(push_time_seconds{exported_job="walg-basebackup", env="gstg", exported_type=~".*patroni.*"}, "type", "$1", "exported_type", "(.*)")) by (environment,type) / 3600
  - alert: walgBackupDelayed
    for: 5m
    annotations:
      title: Last WAL was archived "{{ .Value | humanizeDuration }}" ago for env "{{
        $labels.environment }}."
      description: WAL-G wal-push archiving WALs to GCS might be not working. Please
        follow the runbook to review the problem.
      grafana_datasource_id: mimir-gitlab-gstg
      grafana_min_zoom_hours: "4"
      grafana_variables: environment
      runbook: docs/patroni/postgresql-backups-wale-walg.md
    labels:
      alert_type: symptom
      incident_project: gitlab.com/gitlab-com/gl-infra/production
      severity: s3
    expr: (gitlab_com:last_walg_backup_age_in_seconds{type!="patroni-embedding",  env="gstg"}
      >= 60 * 15) or (gitlab_com:last_walg_backup_age_in_seconds{type="patroni-embedding",
      env="gstg"} >= 60 * 60)
  - alert: walgBaseBackupDelayed
    for: 5m
    annotations:
      title: Last successful WAL-G basebackup was seen "{{ $value }}" hours ago for
        env "{{ $labels.environment }}".
      description: WAL-G backup-push creating full backups and archiving them to GCS
        might be not working. Please follow the runbook to review the problem.
      grafana_datasource_id: mimir-gitlab-gstg
      grafana_min_zoom_hours: "4"
      grafana_variables: environment
      runbook: docs/patroni/alerts/walgBaseBackup.md
    labels:
      alert_type: symptom
      incident_project: gitlab.com/gitlab-com/gl-infra/production
      severity: s3
    expr: gitlab_com:last_walg_successful_basebackup_age_in_hours{ env="gstg", exported_type!~".*14.*|gprd-patroni-security"}
      >= 30
  - alert: WALGBaseBackupFailed
    for: 5m
    annotations:
      title: GitLab Job has failed
      description: The GitLab job "{{ $labels.job }}" resource "{{ $labels.resource
        }}" has failed.
      grafana_datasource_id: mimir-gitlab-gstg
      grafana_min_zoom_hours: "4"
      grafana_variables: environment
      runbook: docs/patroni/alerts/walgBaseBackup.md
    labels:
      alert_type: cause
      incident_project: gitlab.com/gitlab-com/gl-infra/production
      severity: s3
    expr: gitlab_job_failed{resource="walg-basebackup", type!~".+logical.+", env="gstg"}
      == 1
