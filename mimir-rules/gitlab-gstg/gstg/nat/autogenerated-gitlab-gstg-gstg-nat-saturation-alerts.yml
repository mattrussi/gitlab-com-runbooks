# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/saturation.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: GitLab Component Saturation Statistics
  interval: 5m
  rules:
  - record: gitlab_component_saturation:ratio_quantile95_1w
    expr: quantile_over_time(0.95, gitlab_component_saturation:ratio{env="gstg",type="nat"}[1w])
  - record: gitlab_component_saturation:ratio_quantile99_1w
    expr: quantile_over_time(0.99, gitlab_component_saturation:ratio{env="gstg",type="nat"}[1w])
  - record: gitlab_component_saturation:ratio_quantile95_1h
    expr: quantile_over_time(0.95, gitlab_component_saturation:ratio{env="gstg",type="nat"}[1h])
  - record: gitlab_component_saturation:ratio_quantile99_1h
    expr: quantile_over_time(0.99, gitlab_component_saturation:ratio{env="gstg",type="nat"}[1h])
  - record: gitlab_component_saturation:ratio_avg_1h
    expr: avg_over_time(gitlab_component_saturation:ratio{env="gstg",type="nat"}[1h])
- name: GitLab Saturation Alerts
  interval: 1m
  rules:
  - alert: component_saturation_slo_out_of_bounds:nat_gateway_port_allocation
    for: 5m
    annotations:
      title: The Cloud NAT Gateway Port Allocation resource of the {{ $labels.type
        }} service ({{ $labels.stage }} stage) has a saturation exceeding SLO and
        is close to its capacity limit.
      description: |
        This means that this resource is running close to capacity and is at risk of exceeding its current capacity limit.

        Details of the Cloud NAT Gateway Port Allocation resource:

        Each NAT IP address on a Cloud NAT gateway offers 64,512 TCP source ports and 64,512 UDP source ports.

        When these are exhausted, processes may experience connection problems to external destinations. In the application these may manifest as SMTP connection drops or webhook delivery failures. In Kubernetes, nodes may fail while attempting to download images from external repositories.

        More details in the Cloud NAT documentation: https://cloud.google.com/nat/docs/ports-and-addresses
      grafana_dashboard_id: alerts-sat_nat_gw_port_allocation
      grafana_dashboard_link: https://dashboards.gitlab.net/d/alerts-sat_nat_gw_port_allocation?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "1436589381"
      grafana_variables: environment,type,stage
      promql_query: |
        max by(environment, shard, gateway_name, project_id) (
          clamp_min(
            clamp_max(
              sum without(nat_ip) (
                stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                  job="stackdriver",
                  project_id="gitlab-production",
                  environment="{{ $labels.environment }}"
                }
              )
              /
              ( 64512 * 48 )
              or
              sum without(nat_ip) (
                stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                  job="stackdriver",
                  project_id="gitlab-staging-1",
                  environment="{{ $labels.environment }}"
                }
              )
              /
              ( 64512 * 16 )
              ,
              1)
          ,
          0)
        )
      promql_template_1: |
        max by(environment, shard, gateway_name, project_id) (
          clamp_min(
            clamp_max(
              sum without(nat_ip) (
                stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                  job="stackdriver",
                  project_id="gitlab-production",
                  environment="{{ $labels.environment }}"
                }
              )
              /
              ( 64512 * 48 )
              or
              sum without(nat_ip) (
                stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                  job="stackdriver",
                  project_id="gitlab-staging-1",
                  environment="{{ $labels.environment }}"
                }
              )
              /
              ( 64512 * 16 )
              ,
              1)
          ,
          0)
        )
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: cause
      pager: pagerduty
      rules_domain: general
      severity: s2
    expr: |
      gitlab_component_saturation:ratio{component="nat_gateway_port_allocation",env="gstg",type="nat"} > on(component) group_left
      slo:max:hard:gitlab_component_saturation:ratio{component="nat_gateway_port_allocation",env="gstg",type="nat"}
  - alert: component_saturation_slo_out_of_bounds:nat_host_port_allocation
    for: 10m
    annotations:
      title: The Cloud NAT Host Port Allocation resource of the {{ $labels.type }}
        service ({{ $labels.stage }} stage) has a saturation exceeding SLO and is
        close to its capacity limit.
      description: |
        This means that this resource is running close to capacity and is at risk of exceeding its current capacity limit.

        Details of the Cloud NAT Host Port Allocation resource:

        Cloud NAT will allocate a set of NAT ports to each host in a cluster. When these are all allocated, Cloud NAT may be unable to allocate any more.

        When this happens, processes may experience connection problems to external destinations. In the application these may manifest as SMTP connection drops or webhook delivery failures. In Kubernetes, nodes may fail while attempting to download images from external repositories.

        More details in the Cloud NAT documentation: https://cloud.google.com/nat/docs/ports-and-addresses.

        Note: when reviewing the detail chart for this saturation point, the instance_id can be resolved using `gcloud compute instances list --project gitlab-production --filter "id=$instance_id"`.
      grafana_dashboard_id: alerts-sat_nat_host_port_allocation
      grafana_dashboard_link: https://dashboards.gitlab.net/d/alerts-sat_nat_host_port_allocation?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage
        }}
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2254997722"
      grafana_variables: environment,type,stage
      promql_query: |
        max by(environment, shard, instance_id, nat_gateway_name, zone) (
          clamp_min(
            clamp_max(
              sum without(ip_protocol) (
                max_over_time(
                  stackdriver_gce_instance_compute_googleapis_com_nat_port_usage{
                    job="stackdriver",
                    project_id=~"gitlab-production|gitlab-staging-1",
                    environment="{{ $labels.environment }}"
                  }[5m]
                )
              )
              /
              sum without (nat_ip) (
                max_over_time(
                  stackdriver_gce_instance_compute_googleapis_com_nat_allocated_ports{
                    job="stackdriver",
                    project_id=~"gitlab-production|gitlab-staging-1",
                    environment="{{ $labels.environment }}"
                  }[5m]
                )
              )
              ,
              1)
          ,
          0)
        )
      promql_template_1: |
        max by(environment, shard, instance_id, nat_gateway_name, zone) (
          clamp_min(
            clamp_max(
              sum without(ip_protocol) (
                max_over_time(
                  stackdriver_gce_instance_compute_googleapis_com_nat_port_usage{
                    job="stackdriver",
                    project_id=~"gitlab-production|gitlab-staging-1",
                    environment="{{ $labels.environment }}"
                  }[5m]
                )
              )
              /
              sum without (nat_ip) (
                max_over_time(
                  stackdriver_gce_instance_compute_googleapis_com_nat_allocated_ports{
                    job="stackdriver",
                    project_id=~"gitlab-production|gitlab-staging-1",
                    environment="{{ $labels.environment }}"
                  }[5m]
                )
              )
              ,
              1)
          ,
          0)
        )
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s3
    expr: |
      gitlab_component_saturation:ratio{component="nat_host_port_allocation",env="gstg",type="nat"} > on(component) group_left
      slo:max:hard:gitlab_component_saturation:ratio{component="nat_host_port_allocation",env="gstg",type="nat"}
