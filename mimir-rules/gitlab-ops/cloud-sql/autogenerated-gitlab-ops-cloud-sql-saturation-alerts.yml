# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/saturation.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: GitLab Component Saturation Statistics
  interval: 5m
  rules:
  - record: gitlab_component_saturation:ratio_quantile95_1w
    expr: quantile_over_time(0.95, gitlab_component_saturation:ratio{env="ops",type="cloud-sql"}[1w])
  - record: gitlab_component_saturation:ratio_quantile99_1w
    expr: quantile_over_time(0.99, gitlab_component_saturation:ratio{env="ops",type="cloud-sql"}[1w])
  - record: gitlab_component_saturation:ratio_quantile95_1h
    expr: quantile_over_time(0.95, gitlab_component_saturation:ratio{env="ops",type="cloud-sql"}[1h])
  - record: gitlab_component_saturation:ratio_quantile99_1h
    expr: quantile_over_time(0.99, gitlab_component_saturation:ratio{env="ops",type="cloud-sql"}[1h])
  - record: gitlab_component_saturation:ratio_avg_1h
    expr: avg_over_time(gitlab_component_saturation:ratio{env="ops",type="cloud-sql"}[1h])
- name: GitLab Saturation Alerts
  interval: 1m
  rules:
  - alert: component_saturation_slo_out_of_bounds:cloudsql_cpu
    for: 5m
    annotations:
      title: The CloudSQL CPU Utilization resource of the {{ $labels.type }} service
        ({{ $labels.stage }} stage) has a saturation exceeding SLO and is close to
        its capacity limit.
      description: |
        This means that this resource is running close to capacity and is at risk of exceeding its current capacity limit.

        Details of the CloudSQL CPU Utilization resource:

        CloudSQL CPU utilization.

        See https://cloud.google.com/monitoring/api/metrics_gcp#gcp-cloudsql for more details
      grafana_dashboard_id: alerts-sat_cloudsql_cpu
      grafana_dashboard_link: https://dashboards.gitlab.net/d/alerts-sat_cloudsql_cpu?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage
        }}
      grafana_datasource_id: mimir-gitlab-ops
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "3017284519"
      grafana_variables: environment,type,stage
      promql_query: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_cpu_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      promql_template_1: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_cpu_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s4
    expr: |
      gitlab_component_saturation:ratio{component="cloudsql_cpu",env="ops",type="cloud-sql"} > on(component) group_left
      slo:max:hard:gitlab_component_saturation:ratio{component="cloudsql_cpu"}
  - alert: component_saturation_slo_out_of_bounds:cloudsql_disk
    for: 5m
    annotations:
      title: The CloudSQL Disk Utilization resource of the {{ $labels.type }} service
        ({{ $labels.stage }} stage) has a saturation exceeding SLO and is close to
        its capacity limit.
      description: |
        This means that this resource is running close to capacity and is at risk of exceeding its current capacity limit.

        Details of the CloudSQL Disk Utilization resource:

        CloudSQL Disk utilization.

        See https://cloud.google.com/monitoring/api/metrics_gcp#gcp-cloudsql for more details
      grafana_dashboard_id: alerts-sat_cloudsql_disk
      grafana_dashboard_link: https://dashboards.gitlab.net/d/alerts-sat_cloudsql_disk?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage
        }}
      grafana_datasource_id: mimir-gitlab-ops
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "2351208402"
      grafana_variables: environment,type,stage
      promql_query: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_disk_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      promql_template_1: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_disk_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s4
    expr: |
      gitlab_component_saturation:ratio{component="cloudsql_disk",env="ops",type="cloud-sql"} > on(component) group_left
      slo:max:hard:gitlab_component_saturation:ratio{component="cloudsql_disk"}
  - alert: component_saturation_slo_out_of_bounds:cloudsql_memory
    for: 5m
    annotations:
      title: The CloudSQL Memory Utilization resource of the {{ $labels.type }} service
        ({{ $labels.stage }} stage) has a saturation exceeding SLO and is close to
        its capacity limit.
      description: |
        This means that this resource is running close to capacity and is at risk of exceeding its current capacity limit.

        Details of the CloudSQL Memory Utilization resource:

        CloudSQL Memory utilization.

        See https://cloud.google.com/monitoring/api/metrics_gcp#gcp-cloudsql for more details
      grafana_dashboard_id: alerts-sat_cloudsql_memory
      grafana_dashboard_link: https://dashboards.gitlab.net/d/alerts-sat_cloudsql_memory?from=now-6h/m&to=now-1m/m&var-environment={{
        $labels.environment }}&var-type={{ $labels.type }}&var-stage={{ $labels.stage
        }}
      grafana_datasource_id: mimir-gitlab-ops
      grafana_min_zoom_hours: "6"
      grafana_panel_id: "395749012"
      grafana_variables: environment,type,stage
      promql_query: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_memory_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      promql_template_1: |
        max by(database_id,environment,shard) (
          clamp_min(
            clamp_max(
              avg_over_time(stackdriver_cloudsql_database_cloudsql_googleapis_com_database_memory_utilization{environment="{{ $labels.environment }}"}[5m])
              ,
              1)
          ,
          0)
        )
      runbook: docs/{{ $labels.type }}/README.md
    labels:
      alert_type: cause
      rules_domain: general
      severity: s4
    expr: |
      gitlab_component_saturation:ratio{component="cloudsql_memory",env="ops",type="cloud-sql"} > on(component) group_left
      slo:max:hard:gitlab_component_saturation:ratio{component="cloudsql_memory"}
