# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/saturation.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Saturation Rules (autogenerated)
  interval: 1m
  rules:
  - record: gitlab_component_saturation:ratio
    labels:
      component: nat_gateway_port_allocation
      stage: main
      tier: inf
      type: nat
    expr: |
      max by(env, environment, shard) (
        clamp_min(
          clamp_max(
            sum without(nat_ip) (
              stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                job="stackdriver",
                project_id="gitlab-production",
                env="ops",type="nat"
              }
            )
            /
            ( 64512 * 48 )
            or
            sum without(nat_ip) (
              stackdriver_nat_gateway_router_googleapis_com_nat_allocated_ports{
                job="stackdriver",
                project_id="gitlab-staging-1",
                env="ops",type="nat"
              }
            )
            /
            ( 64512 * 16 )
            ,
            1)
        ,
        0)
      )
  - record: gitlab_component_saturation:ratio
    labels:
      component: nat_host_port_allocation
      stage: main
      tier: inf
      type: nat
    expr: |
      max by(env, environment, shard) (
        clamp_min(
          clamp_max(
            sum without(ip_protocol) (
              max_over_time(
                stackdriver_gce_instance_compute_googleapis_com_nat_port_usage{
                  job="stackdriver",
                  project_id=~"gitlab-production|gitlab-staging-1",
                  env="ops",type="nat"
                }[5m]
              )
            )
            /
            sum without (nat_ip) (
              max_over_time(
                stackdriver_gce_instance_compute_googleapis_com_nat_allocated_ports{
                  job="stackdriver",
                  project_id=~"gitlab-production|gitlab-staging-1",
                  env="ops",type="nat"
                }[5m]
              )
            )
            ,
            1)
        ,
        0)
      )
