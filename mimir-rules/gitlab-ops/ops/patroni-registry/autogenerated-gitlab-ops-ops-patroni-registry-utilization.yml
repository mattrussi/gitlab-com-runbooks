# WARNING. DO NOT EDIT THIS FILE BY HAND. USE ./mimir-rules-jsonnet/utilization.jsonnet TO GENERATE IT
# YOUR CHANGES WILL BE OVERRIDDEN
groups:
- name: Utilization Rules (autogenerated)
  interval: 5m
  rules:
  - record: gitlab_component_utilization:pg_table_size_bytes:topk:1h
    labels:
      component: pg_table_size
      metrics_subsystem: utilization
      resource_labels: relname
      summaryType: topk
      unit: bytes
    expr: |
      topk by(env,tier,type,stage) (10,
        avg by (env,tier,type,stage,relname) (
          avg_over_time(pg_total_relation_size_bytes{env="ops",type="patroni-registry"}[1h])
          and on (job, instance) (
            pg_replication_is_replica{env="ops",type="patroni-registry"} == 0
          )
        )
      )
  - record: gitlab_component_utilization:pg_vacuum_time_per_day_seconds:1d
    labels:
      component: pg_vacuum_time_per_day
      metrics_subsystem: utilization
      summaryType: aggregate
      unit: seconds
    expr: |
      sum by (env,tier,type,stage) (
        increase(fluentd_pg_auto_vacuum_elapsed_seconds_total{env="ops",type="patroni-registry"}[1d])
      )
  - record: gitlab_component_utilization:pg_wraparound_time_seconds:1d
    labels:
      component: pg_wraparound_time
      metrics_subsystem: utilization
      summaryType: aggregate
      unit: seconds
    expr: |
      (2^31 - 10^6)
      /
      (
        avg by (env,tier,type,stage) (deriv(pg_txid_current{env="ops",type="patroni-registry"}[1d]) > 0)
      )
